var D=Object.defineProperty;var N=(s,t,e)=>t in s?D(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>N(s,typeof t!="symbol"?t+"":t,e);import{aZ as l}from"./index-B1yGdhtz.js";import{N as _}from"./walletConnect-BmfqopVd.js";import{L as A,S as y,T as p,h as b,j as z,k as S,m as I,D as R,n as O}from"./privyConnector--nGFtbB8.js";import{g as q}from"./index-TjLUG_Bo.js";import{r as F}from"./index-DPLYdhO9.js";import"./jsx-runtime-DF5SV9au.js";import"./isAddressEqual-BZ0F7Med.js";import"./index.es-CQTua3R0.js";import"./sha3-C47P6eDd.js";import"./_u64-CPCIv9dJ.js";import"./hooks.module-B3Nfv_UP.js";import"./index-7JkPJWjm.js";import"./index-BHYcTakE.js";import"./sha2-Cuix5xAA.js";const X="transport";class f{constructor({context:t,logType:e}={}){r(this,"exchangeTimeout",3e4);r(this,"unresponsiveTimeout",15e3);r(this,"deviceModel",null);r(this,"tracer");r(this,"_events",new _);r(this,"send",async(t,e,i,n,o=l.alloc(0),a=[y.OK],{abortTimeoutMs:c}={})=>{const d=this.tracer.withUpdatedContext({function:"send"});if(o.length>=256)throw d.trace("data.length exceeded 256 bytes limit",{dataLength:o.length}),new p("data.length exceed 256 bytes limit. Got: "+o.length,"DataLengthTooBig");d.trace("Starting an exchange",{abortTimeoutMs:c});const m=await this.exchange(l.concat([l.from([t,e,i,n]),l.from([o.length]),o]),{abortTimeoutMs:c});d.trace("Received response from exchange");const h=m.readUInt16BE(m.length-2);if(!a.some(C=>C===h))throw new b(h);return m});r(this,"exchangeBusyPromise");r(this,"_appAPIlock",null);this.tracer=new A(e??X,t)}exchange(t,{abortTimeoutMs:e}={}){throw new Error("exchange not implemented")}exchangeBulk(t,e){let i=!1;const n=()=>{i=!0};return(async()=>{if(!i)for(const a of t){const c=await this.exchange(a);if(i)return;const d=c.readUInt16BE(c.length-2);if(d!==y.OK)throw new b(d);e.next(c)}})().then(()=>!i&&e.complete(),a=>!i&&e.error(a)),{unsubscribe:n}}setScrambleKey(t){}close(){return Promise.resolve()}on(t,e){this._events.on(t,e)}off(t,e){this._events.removeListener(t,e)}emit(t,...e){this._events.emit(t,...e)}setDebugMode(){console.warn("setDebugMode is deprecated. use @ledgerhq/logs instead. No logs are emitted in this anymore.")}setExchangeTimeout(t){this.exchangeTimeout=t}setExchangeUnresponsiveTimeout(t){this.unresponsiveTimeout=t}static create(t=3e3,e){return new Promise((i,n)=>{let o=!1;const a=this.listen({next:d=>{o=!0,a&&a.unsubscribe(),c&&clearTimeout(c),this.open(d.descriptor,t).then(i,n)},error:d=>{c&&clearTimeout(c),n(d)},complete:()=>{c&&clearTimeout(c),o||n(new p(this.ErrorMessage_NoDeviceFound,"NoDeviceFound"))}}),c=e?setTimeout(()=>{a.unsubscribe(),n(new p(this.ErrorMessage_ListenTimeout,"ListenTimeout"))},e):null})}async exchangeAtomicImpl(t){const e=this.tracer.withUpdatedContext({function:"exchangeAtomicImpl",unresponsiveTimeout:this.unresponsiveTimeout});if(this.exchangeBusyPromise)throw e.trace("Atomic exchange is already busy"),new z("An action was already pending on the Ledger device. Please deny or reconnect.");let i;const n=new Promise(c=>{i=c});this.exchangeBusyPromise=n;let o=!1;const a=setTimeout(()=>{e.trace('Timeout reached, emitting Transport event "unresponsive"',{unresponsiveTimeout:this.unresponsiveTimeout}),o=!0,this.emit("unresponsive")},this.unresponsiveTimeout);try{const c=await t();return o&&(e.trace("Device was unresponsive, emitting responsive"),this.emit("responsive")),c}finally{e.trace("Finalize, clearing busy guard"),clearTimeout(a),i&&i(),this.exchangeBusyPromise=null}}decorateAppAPIMethods(t,e,i){for(const n of e)t[n]=this.decorateAppAPIMethod(n,t[n],t,i)}decorateAppAPIMethod(t,e,i,n){return async(...o)=>{const{_appAPIlock:a}=this;if(a)return Promise.reject(new p("Ledger Device is busy (lock "+a+")","TransportLocked"));try{return this._appAPIlock=t,this.setScrambleKey(n),await e.apply(i,o)}finally{this._appAPIlock=null}}}setTraceContext(t){this.tracer=this.tracer.withContext(t)}updateTraceContext(t){this.tracer.updateContext(t)}getTraceContext(){return this.tracer.getContext()}}r(f,"isSupported"),r(f,"list"),r(f,"listen"),r(f,"open"),r(f,"ErrorMessage_ListenTimeout","No Ledger device found (timeout)"),r(f,"ErrorMessage_NoDeviceFound","No Ledger device found");const U=5;function V(s){const t=l.alloc(2);return t.writeUInt16BE(s,0),t}const K={data:l.alloc(0),dataLength:0,sequence:0},G=(s,t)=>({makeBlocks(e){let i=l.concat([V(e.length),e]);const n=t-5,o=Math.ceil(i.length/n);i=l.concat([i,l.alloc(o*n-i.length+1).fill(0)]);const a=[];for(let c=0;c<o;c++){const d=l.alloc(5);d.writeUInt16BE(s,0),d.writeUInt8(U,2),d.writeUInt16BE(c,3);const m=i.slice(c*n,(c+1)*n);a.push(l.concat([d,m]))}return a},reduceResponse(e,i){let{data:n,dataLength:o,sequence:a}=e||K;if(i.readUInt16BE(0)!==s)throw new p("Invalid channel","InvalidChannel");if(i.readUInt8(2)!==U)throw new p("Invalid tag","InvalidTag");if(i.readUInt16BE(3)!==a)throw new p("Invalid sequence","InvalidSequence");e||(o=i.readUInt16BE(5)),a++;const c=i.slice(e?5:7);return n=l.concat([n,c]),n.length>o&&(n=n.slice(0,o)),{data:n,dataLength:o,sequence:a}},getReducedResult(e){if(e&&e.dataLength===e.data.length)return e.data}});var j=F();const P=q(j);var u;(function(s){s.blue="blue",s.nanoS="nanoS",s.nanoSP="nanoSP",s.nanoX="nanoX",s.stax="stax",s.europa="europa"})(u||(u={}));const w={[u.blue]:{id:u.blue,productName:"Ledger Blue",productIdMM:0,legacyUsbProductId:0,usbOnly:!0,memorySize:480*1024,masks:[822083584,822149120],getBlockSize:s=>4*1024},[u.nanoS]:{id:u.nanoS,productName:"Ledger Nano S",productIdMM:16,legacyUsbProductId:1,usbOnly:!0,memorySize:320*1024,masks:[823132160],getBlockSize:s=>P.lt(P.coerce(s)??"","2.0.0")?4*1024:2*1024},[u.nanoX]:{id:u.nanoX,productName:"Ledger Nano X",productIdMM:64,legacyUsbProductId:4,usbOnly:!1,memorySize:2*1024*1024,masks:[855638016],getBlockSize:s=>4*1024,bluetoothSpec:[{serviceUuid:"13d63400-2c97-0004-0000-4c6564676572",notifyUuid:"13d63400-2c97-0004-0001-4c6564676572",writeUuid:"13d63400-2c97-0004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-0004-0003-4c6564676572"}]},[u.nanoSP]:{id:u.nanoSP,productName:"Ledger Nano S Plus",productIdMM:80,legacyUsbProductId:5,usbOnly:!0,memorySize:1533*1024,masks:[856686592],getBlockSize:s=>32},[u.stax]:{id:u.stax,productName:"Ledger Stax",productIdMM:96,legacyUsbProductId:6,usbOnly:!1,memorySize:1533*1024,masks:[857735168],getBlockSize:s=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-6004-0000-4c6564676572",notifyUuid:"13d63400-2c97-6004-0001-4c6564676572",writeUuid:"13d63400-2c97-6004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-6004-0003-4c6564676572"}]},[u.europa]:{id:u.europa,productName:"Ledger Flex",productIdMM:112,legacyUsbProductId:7,usbOnly:!1,memorySize:1533*1024,masks:[858783744],getBlockSize:s=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-3004-0000-4c6564676572",notifyUuid:"13d63400-2c97-3004-0001-4c6564676572",writeUuid:"13d63400-2c97-3004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-3004-0003-4c6564676572"}]}};u.blue,u.nanoS,u.nanoSP,u.nanoX,u.stax,u.europa;const k=Object.values(w),M=11415,L=s=>{const t=k.find(n=>n.legacyUsbProductId===s);if(t)return t;const e=s>>8;return k.find(n=>n.productIdMM===e)},Y=[],B={};for(const s in w){const t=w[s],{bluetoothSpec:e}=t;if(e)for(let i=0;i<e.length;i++){const n=e[i];Y.push(n.serviceUuid),B[n.serviceUuid]=B[n.serviceUuid.replace(/-/g,"")]={deviceModel:t,...n}}}const Z=[{vendorId:M}],J=()=>Promise.resolve(!!(window.navigator&&window.navigator.hid)),v=()=>{const{hid:s}=navigator;if(!s)throw new p("navigator.hid is not supported","HIDNotSupported");return s};async function T(){const s=await v().requestDevice({filters:Z});return Array.isArray(s)?s:[s]}async function x(){return(await v().getDevices()).filter(t=>t.vendorId===M)}async function Q(){const s=await x();return s.length>0?s[0]:(await T())[0]}const g=class g extends f{constructor(e){super();r(this,"device");r(this,"deviceModel");r(this,"channel",Math.floor(Math.random()*65535));r(this,"packetSize",64);r(this,"inputs",[]);r(this,"inputCallback");r(this,"read",()=>this.inputs.length?Promise.resolve(this.inputs.shift()):new Promise(e=>{this.inputCallback=e}));r(this,"onInputReport",e=>{const i=l.from(e.data.buffer);this.inputCallback?(this.inputCallback(i),this.inputCallback=null):this.inputs.push(i)});r(this,"_disconnectEmitted",!1);r(this,"_emitDisconnect",e=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",e))});r(this,"exchange",async e=>await this.exchangeAtomicImpl(async()=>{const{channel:n,packetSize:o}=this;I("apdu","=> "+e.toString("hex"));const a=G(n,o),c=a.makeBlocks(e);for(let h=0;h<c.length;h++)await this.device.sendReport(0,c[h]);let d,m;for(;!(d=a.getReducedResult(m));)try{const h=await this.read();m=a.reduceResponse(m,h)}catch(h){if(h instanceof p&&h.id==="InvalidChannel")continue;throw h}return I("apdu","<= "+d.toString("hex")),d}).catch(n=>{throw n&&n.message&&n.message.includes("write")?(this._emitDisconnect(n),new R(n.message)):n}));this.device=e,this.deviceModel=typeof e.productId=="number"?L(e.productId):void 0,e.addEventListener("inputreport",this.onInputReport)}static async request(){const[e]=await T();return g.open(e)}static async openConnected(){const e=await x();return e.length===0?null:g.open(e[0])}static async open(e){await e.open();const i=new g(e),n=o=>{e===o.device&&(v().removeEventListener("disconnect",n),i._emitDisconnect(new O))};return v().addEventListener("disconnect",n),i}async close(){await this.exchangeBusyPromise,this.device.removeEventListener("inputreport",this.onInputReport),await this.device.close()}setScrambleKey(){}};r(g,"isSupported",J),r(g,"list",x),r(g,"listen",e=>{let i=!1;Q().then(o=>{if(!o)e.error(new S("Access denied to use Ledger device"));else if(!i){const a=typeof o.productId=="number"?L(o.productId):void 0;e.next({type:"add",descriptor:o,deviceModel:a}),e.complete()}},o=>{e.error(new S(o.message))});function n(){i=!0}return{unsubscribe:n}});let E=g;export{E as default};
