import{b as f,af as k,x as g,ag as S,a as y,u,B as w,A,a6 as N}from"./index-hE0wlW8G.js";import"./index-B1yGdhtz.js";import"./index-TjLUG_Bo.js";import"./jsx-runtime-DF5SV9au.js";import"./walletConnect-BmfqopVd.js";import"./index.es-CQTua3R0.js";import"./privyConnector--nGFtbB8.js";import"./isAddressEqual-BZ0F7Med.js";import"./sha3-C47P6eDd.js";import"./_u64-CPCIv9dJ.js";import"./hooks.module-B3Nfv_UP.js";import"./index-7JkPJWjm.js";import"./index-BHYcTakE.js";import"./sha2-Cuix5xAA.js";import"./lit-html-_TTrhfbU.js";import"./lit-element-nGwg5-HZ.js";class I{constructor(e){this.getNonce=e.getNonce}async createMessage(e){const t={accountAddress:e.accountAddress,chainId:e.chainId,version:"1",domain:typeof document>"u"?"Unknown Domain":document.location.host,uri:typeof document>"u"?"Unknown URI":document.location.href,resources:this.resources,nonce:await this.getNonce(e),issuedAt:this.stringifyDate(new Date),statement:void 0,expirationTime:void 0,notBefore:void 0};return Object.assign(t,{toString:()=>this.stringify(t)})}stringify(e){var o;const t=this.getNetworkName(e.chainId);return[`${e.domain} wants you to sign in with your ${t} account:`,e.accountAddress,e.statement?`
${e.statement}
`:"",`URI: ${e.uri}`,`Version: ${e.version}`,`Chain ID: ${e.chainId}`,`Nonce: ${e.nonce}`,e.issuedAt&&`Issued At: ${e.issuedAt}`,e.expirationTime&&`Expiration Time: ${e.expirationTime}`,e.notBefore&&`Not Before: ${e.notBefore}`,e.requestId&&`Request ID: ${e.requestId}`,((o=e.resources)==null?void 0:o.length)&&e.resources.reduce((s,n)=>`${s}
- ${n}`,"Resources:")].filter(s=>typeof s=="string").join(`
`).trim()}getNetworkName(e){const t=f.getAllRequestedCaipNetworks();return k.getNetworkNameByCaipNetworkId(t,e)}stringifyDate(e){return e.toISOString()}}class B{constructor(e={}){this.otpUuid=null,this.listeners={sessionChanged:[]},this.localAuthStorageKey=e.localAuthStorageKey||g.SIWX_AUTH_TOKEN,this.localNonceStorageKey=e.localNonceStorageKey||g.SIWX_NONCE_TOKEN,this.required=e.required??!0,this.messenger=new I({getNonce:this.getNonce.bind(this)})}async createMessage(e){return this.messenger.createMessage(e)}async addSession(e){const t=await this.request({method:"POST",key:"authenticate",body:{data:e.data,message:e.message,signature:e.signature,clientId:this.getClientId(),walletInfo:this.getWalletInfo()},headers:["nonce","otp"]});this.setStorageToken(t.token,this.localAuthStorageKey),this.emit("sessionChanged",e),this.setAppKitAccountUser(T(t.token)),this.otpUuid=null}async getSessions(e,t){try{if(!this.getStorageToken(this.localAuthStorageKey))return[];const o=await this.request({method:"GET",key:"me",query:{},headers:["auth"]});if(!o)return[];const s=o.address.toLowerCase()===t.toLowerCase(),n=o.caip2Network===e;if(!s||!n)return[];const r={data:{accountAddress:o.address,chainId:o.caip2Network},message:"",signature:""};return this.emit("sessionChanged",r),this.setAppKitAccountUser(o),[r]}catch{return[]}}async revokeSession(e,t){return Promise.resolve(this.clearStorageTokens())}async setSessions(e){if(e.length===0)this.clearStorageTokens();else{const t=e.find(o=>{var s;return o.data.chainId===((s=S())==null?void 0:s.caipNetworkId)})||e[0];await this.addSession(t)}}getRequired(){return this.required}async getSessionAccount(){if(!this.getStorageToken(this.localAuthStorageKey))throw new Error("Not authenticated");return this.request({method:"GET",key:"me",body:void 0,query:{includeAppKitAccount:!0},headers:["auth"]})}async setSessionAccountMetadata(e=null){if(!this.getStorageToken(this.localAuthStorageKey))throw new Error("Not authenticated");return this.request({method:"PUT",key:"account-metadata",body:{metadata:e},headers:["auth"]})}on(e,t){return this.listeners[e].push(t),()=>{this.listeners[e]=this.listeners[e].filter(o=>o!==t)}}removeAllListeners(){Object.keys(this.listeners).forEach(t=>{this.listeners[t]=[]})}async requestEmailOtp({email:e,account:t}){const o=await this.request({method:"POST",key:"otp",body:{email:e,account:t}});return this.otpUuid=o.uuid,this.messenger.resources=[`email:${e}`],o}confirmEmailOtp({code:e}){return this.request({method:"PUT",key:"otp",body:{code:e},headers:["otp"]})}async request({method:e,key:t,query:o,body:s,headers:n}){var l;const{projectId:r,st:m,sv:p}=this.getSDKProperties(),a=new URL(`${y.W3M_API_URL}/auth/v1/${String(t)}`);a.searchParams.set("projectId",r),a.searchParams.set("st",m),a.searchParams.set("sv",p),o&&Object.entries(o).forEach(([i,h])=>a.searchParams.set(i,String(h)));const c=await fetch(a,{method:e,body:s?JSON.stringify(s):void 0,headers:Array.isArray(n)?n.reduce((i,h)=>{switch(h){case"nonce":i["x-nonce-jwt"]=`Bearer ${this.getStorageToken(this.localNonceStorageKey)}`;break;case"auth":i.Authorization=`Bearer ${this.getStorageToken(this.localAuthStorageKey)}`;break;case"otp":this.otpUuid&&(i["x-otp"]=this.otpUuid);break}return i},{}):void 0});if(!c.ok)throw new Error(await c.text());return(l=c.headers.get("content-type"))!=null&&l.includes("application/json")?c.json():null}getStorageToken(e){return u.getItem(e)}setStorageToken(e,t){u.setItem(t,e)}clearStorageTokens(){this.otpUuid=null,u.removeItem(this.localAuthStorageKey),u.removeItem(this.localNonceStorageKey),this.emit("sessionChanged",void 0)}async getNonce(){const{nonce:e,token:t}=await this.request({method:"GET",key:"nonce"});return this.setStorageToken(t,this.localNonceStorageKey),e}getClientId(){return w.state.clientId}getWalletInfo(){const{connectedWalletInfo:e}=A.state;if(!e)return;if("social"in e){const n=e.social,r=e.identifier;return{type:"social",social:n,identifier:r}}const{name:t,icon:o}=e;let s="unknown";switch(e.type){case"EXTERNAL":case"INJECTED":case"ANNOUNCED":s="extension";break;case"WALLET_CONNECT":s="walletconnect";break;default:s="unknown"}return{type:s,name:t,icon:o}}getSDKProperties(){return N._getSdkProperties()}emit(e,t){this.listeners[e].forEach(o=>o(t))}setAppKitAccountUser(e){const{email:t}=e;t&&Object.values(y.CHAIN).forEach(o=>{f.setAccountProp("user",{email:t},o)})}}function T(d){const e=d.split(".");if(e.length!==3)throw new Error("Invalid token");const t=e[1];if(typeof t!="string")throw new Error("Invalid token");const o=t.replace(/-/gu,"+").replace(/_/gu,"/"),s=o.padEnd(o.length+(4-o.length%4)%4,"=");return JSON.parse(atob(s))}export{B as ReownAuthentication,I as ReownAuthenticationMessenger};
